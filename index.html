<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title>H2OOpenMap</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="stylesheet" href="basic_stylesheet.css" type="text/css" media="all">

<script type="text/javascript">
//https://code.google.com/p/microajax/
function microAjax(B,A){this.bindFunction=function(E,D){return function(){return E.apply(D,[D])}};this.stateChange=function(D){if(this.request.readyState==4){this.callbackFunction(this.request.responseText)}};this.getRequest=function(){if(window.ActiveXObject){return new ActiveXObject("Microsoft.XMLHTTP")}else{if(window.XMLHttpRequest){return new XMLHttpRequest()}}return false};this.postBody=(arguments[2]||"");this.callbackFunction=A;this.url=B;this.request=this.getRequest();if(this.request){var C=this.request;C.onreadystatechange=this.bindFunction(this.stateChange,this);if(this.postBody!==""){C.open("POST",B,true);C.setRequestHeader("X-Requested-With","XMLHttpRequest"); C.setRequestHeader("Content-type","application/x-www-form-urlencoded");C.setRequestHeader("Connection","close")}else{C.open("GET",B,true)}C.send(this.postBody)}};
</script>

</head>
<body>
    <div id='menu'>
    <a href="../">back to H2OpenMap web site</a>
    </div>
	<div id='map'></div>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <!-- leaflet.markercluster -->
<!---->
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css' rel='stylesheet' />
<link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-hash/v0.2.1/leaflet-hash.js'></script>
<!---->
    <script >

    //creo una mappa con relativa posizione e zoom iniziali
     var map = L.map('map').setView([12.68321, -0.74158], 7);

    //aggiungo un layer di sfondo, o Base Layer
    var baseLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http:// mapbox.com">Mapbox</a>',
            maxZoom: 18
        }).addTo(map);

var hash = L.hash(map);

    // Icona Marker
    var singleIcon = L.icon({
        iconUrl: 'img/india32.png', // the icon for india style pumps
    //  shadowUrl: 'img/chose_one.png', // not defined yet......
        iconSize:     [20, 20], // size of the icon
        shadowSize:   [20, 20], // size of the shadow
        iconAnchor:   [0, 0], // point of the icon which will correspond to marker's location
        shadowAnchor: [0, 0],  // the same for the shadow
        popupAnchor:  [10, 20] // point from which the popup should open relative to the iconAnchor
    });

    // Oggetto marker
	var singleMarker = L.marker([12.6923891, -2.1997114], {
		icon:singleIcon
	})
	    .bindPopup('<b>Node 3315201454</b><br>Tags:<br>access=yes<br>drinking_water=yes<br>man_made=water_well<br>pump=manual<br>source=Rasmata Onlus<br><br>Coordinates:<br>12.6923891  -2.1997114 (lat,lon)')
	    .openPopup()
	    .addTo(map)


	// Icona GeoJSON
	var wwIcon = L.icon ({
	    iconUrl: 'img/water_tap32.png',
    //  shadowUrl: 'img/chose_one.png', // not defined yet......
	    iconSize:     [20, 20], // size of the icon
	    shadowSize:   [20, 20], // size of the shadow
	    iconAnchor:   [0, 0 ], // point of the icon which will correspond to marker's location
	    shadowAnchor: [0, 0],  // the same for the shadow
	    popupAnchor:  [10, 0] // point from which the popup should open relative to the iconAnchor
	});


var markers = new L.MarkerClusterGroup();

microAjax('water_well.geojson',function (res) { 
var water_well=JSON.parse(res);
	// Dati GeoJSON
water_well.features.forEach(function(well)
{
console.log(well);
	  		lat = well.geometry.coordinates[0];
	  		lng = well.geometry.coordinates[1];
            //come si deve fare per eliminare tutto quello che segue e listare di volta in volta solo le proprietà definite?
            id = well.id;
            man_made = well.properties.man_made;
            pump = well.properties.pump;
            condition = well.properties.condition;
            disused = well.properties.disused;
            aband = well.properties.abandoned;
            access = well.properties.access;
            drinking_water = well.properties.drinking_water;
            operator = well.properties.operator;
            op_type = well.properties.operator_type;
            name = well.properties.name;
            source = well.properties.source;
            note = well.properties.note;
            fixme = well.properties.fixme;
            //Rasmata Onlus tags
            ww_type = well.properties.water_well_type;
            top_type = well.properties.top_type;
            m_pump_type = well.properties.manual_pump_type;
            image = well.properties.image;
            // MVP Columbia Universiti tags
            ele = well.properties.ele;
            grid = well.properties.grid_proximity;
            district = well.properties.is_in_district;
            region = well.properties.is_in_region;
            operational_status = well.properties.operational_status;
            pipe_connection = well.properties.pipe_connection;
            seasonal = well.properties.seasonal;
            source_date = well.properties.source_date;
            source_ele = well.properties.source_ele;
            ww_source_type = well.properties.water_wells_source_type;
	  		
            var mrkr= L.marker([lng,lat], {icon: wwIcon}).bindPopup(
                "<b>id=</b> <a target='_blank' href='//www.openstreetmap.org/"+id+"'>"+id+"</a><br>"+
                "<b>man_made=</b> "+man_made+"<br>"+
                "<b>position=</b> lat:"+lat+" lon:"+lng+"<br><br>"+

                "<b><u>common tags</u></b><br><br>"+

                "<b>pump=</b> "+pump+"<br>"+
                "<b>condition=</b> "+condition+"<br>"+
                "<b>disused=</b> "+disused+"<br>"+
                "<b>abandoned=</b> "+aband+"<br>"+
                "<b>access=</b> "+access+"<br>"+
                "<b>drinking_water=</b> "+drinking_water+"<br>"+
                "<b>operator=</b> "+operator+"<br>"+
                "<b>operator:type=</b> "+op_type+"<br>"+
                "<b>name=</b> "+name+"<br>"+
                "<b>source=</b> "+source+"<br>"+
                "<b>note=</b> "+note+"<br>"+
                "<b>fixme=</b> "+fixme+"<br><br>"+

                "<b><u>rasmataonlus tags</u></b><br><br>"+

                "<b>water_well_type=</b> "+ww_type+"<br>"+
                "<b>top_type=</b> "+top_type+"<br>"+
                "<b>manual_pump_type=</b> "+m_pump_type+"<br>"+
                "<b>image=</b> "+image+"<br><br>"+

                "<b><u>MVP Columbia University tags</u></b><br><br>"+

                "<b>ele=</b> "+ele+"<br>"+
                "<b>grid=</b> "+grid+"<br>"+
                "<b>district=</b> "+district+"<br>"+
                "<b>region=</b> "+region+"<br>"+
                "<b>operational_status=</b> "+operational_status+"<br>"+
                "<b>disused=</b> "+disused+"<br>"+
                "<b>pipe_connection=</b> "+pipe_connection+"<br>"+
                "<b>seasonal=</b> "+seasonal+"<br>"+
                "<b>source_date=</b> "+source_date+"<br>"+
                "<b>source_ele=</b> "+source_ele+"<br>"+
                "<b>water_wells_source_type=</b> "+ww_source_type+"<br>"
                );
        mrkr.addTo(markers);
	  	});
map.addLayer(markers);
});

	  // Mapbox Streets
//---------------
var mapboxTilesStreet = L.tileLayer('https://{s}.tiles.mapbox.com/v3/examples.map-i86nkdio/{z}/{x}/{y}.png', {
        attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
    })

// Mapbox Medieval
// ---------------
var mapboxTilesMedieval = L.tileLayer('https://{s}.tiles.mapbox.com/v3/spatial.b625e395/{z}/{x}/{y}.png', {
        attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
    }); 

// Creo due oggetti con i riferimenti rispettivamente ai BaseLayers ed ai FeatureLayers
    var baseMaps={
        "Sfondo OSM": baseLayer,
        "Sfondo Mapbox Streets": mapboxTilesStreet,
        "Sfondo Mapbox Medieval": mapboxTilesMedieval
    };
    var featureLayers={
        "water well": markers,
        "water well Nanoro" : singleMarker
    };
    // Creo i controlli
    L.control.layers(baseMaps, featureLayers).addTo(map);
    // Per un metodo moolto più succinto (che usa però Mapbox.js) guardare questo link: https://www.mapbox.com/mapbox.js/example/v1.0.0/toggle-baslayers/

	</script>

</body>
</html>
