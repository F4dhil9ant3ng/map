<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf8" />
    <title>H2OpenMap</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-hash/v0.2.1/leaflet-hash.js'></script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.6/zepto.min.js'></script>

    <script src='js/leaflet-layerjson.min.js'></script>

    <link rel="stylesheet" href="css/easy-button.css" />
    <script src='js/easy-button.js'></script>
    <link rel="stylesheet" href="css/stylesheet.css" />
</head>
<body>

<div id="map"></div>

<div id="legend">
<img src="H2OpenMap_icon_2.png" style="width:100px;height:100px;" />
<p style="float:right"><a href="#" onclick="$('#legend').css('display','none');">x</a></p>
<h3>legend</h3>

<img src="icons/flywheel_yes_no.png" style="display:inline-block"/> flyweel - drinking water yes<br/>
<img src="icons/flywheel_no_no.png" style="display:inline-block"/> flyweel drinking - water no<br/>
<img src="icons/flywheel_no_yes.png" style="display:inline-block"/> flyweel - no water<br/>
<img src="icons/flywheel_unknown.png" style="display:inline-block"/> flyweel - unknow status<br/><br/>

<img src="icons/lever_unknown.png" style="display:inline-block"/> lever pump - drinking water yes<br/>
<img src="icons/lever_no_no.png" style="display:inline-block"/> lever pump - drinking water no<br/>
<img src="icons/lever_no_yes.png" style="display:inline-block"/> lever pump - no water<br/>
<img src="icons/lever_yes_no.png" style="display:inline-block"/> lever pump - unknow status<br/><br/>

<img src="icons/pedal_yes_no.png" style="display:inline-block"/> pedal - drinking water yes<br/>
<img src="icons/pedal_no_no.png" style="display:inline-block"/> pedal - drinking water no<br/>
<img src="icons/pedal_no_yes.png" style="display:inline-block"/> pedal - no water<br/>
<img src="icons/pedal_unknown.png" style="display:inline-block"/> pedal - unknow status<br/><br/>

<img src="icons/pump_manual.png" style="display:inline-block"/> unknown pump<br/><br/>

<img src="icons/tap_yes_no.png" style="display:inline-block"/> water tap - drinking water yes<br/>
<img src="icons/tap_no_no.png" style="display:inline-block"/> water tap - drinking water no<br/>
<img src="icons/tap_no_yes.png" style="display:inline-block"/> water tap - no water<br/>
<img src="icons/tap_unknown.png" style="display:inline-block"/> water tap - unknow status<br/><br/>

<img src="icons/water_well_unknown.png" style="display:inline-block"/> unknown water well<br/><br/>

<img src="icons/well_yes_no.png" style="display:inline-block"/> water well - drinking water yes<br/>
<img src="icons/well_no_no.png" style="display:inline-block"/> water well - drinking water no<br/>
<img src="icons/well_no_yes.png" style="display:inline-block"/> water well - no water<br/>
<img src="icons/well_unknown.png" style="display:inline-block"/> water well - unknow status<br/>

<div class="note">this map is a beta version, some issue still need work. <br/>
please refer to <a href="https://github.com/H2OpenMap" target="blank">github H2OpenMap repository </a> to join us.<br/>map made with the Stefano Sabatini great help! </div>

</div>

<script>
var h2icon = L.Icon.extend({
    options: {
        iconSize:     [20, 20],
        iconAnchor:   [10, 20],
        popupAnchor:  [0, -20]
    }
});

function chooseIcon(feature) {
    var drinkable = 'unknown';

    if(feature['drinking_water'] == 'yes' || feature['drinking_water'] == 'no') {
        drinkable = feature['drinking_water'];
    }

    if(feature['drinking_water'] == 'no') {
        drinkable = 'no';
    }

    var dry = 'no';
    if(feature['dry'] == 'yes') {
        dry = 'yes';
    }
    var featureType = 'well';

    if(feature['pump'] == 'manual' && feature['pump:manual'] == '') {
        featureType = 'pump';
    }

    if(feature['pump:manual'] == 'flywheel') {
        featureType = 'flywheel';
    }

    if(feature['pump:manual'] == 'pedal') {
        featureType = 'pedal';
    }

    if(feature['pump:manual'] == 'lever') {
        featureType = 'lever';
    }

    if(feature['amenity'] == 'drinking_water') {
        featureType = 'tap';
    }




    if (feature['condition'] == 'deficient' && drinkable == 'unknown')
        return 'icons/'+featureType+'_no_yes.png';
    else if (drinkable == 'unknown')
        return 'icons/'+featureType+'_'+drinkable+'.png';
    else
        return 'icons/'+featureType+'_'+drinkable+'_'+dry+'.png';
}

function buildPopup(feature, hasImage) {
        var markerText = '';

        markerText+='<a href="#" class=""><img src="H2OpenMap_icon_2.png" style="width:50px;height:50px;" /></a><br/>';

        var image = feature['img'];
        if (image === null || image == '' || hasImage == false) image = 'default.png';
        markerText+='<a href="img/'+image+'" class=""><img src="img/'+image+'" style="width:200px;height:200px;" /></a>';
        
        if(feature ['survey:date']!='')
            markerText+='<p><b>survey date =</b> '+feature['survey:date']+'<br/>';

        //if(hasImage []!='')
            //markerText+='<b>position =</b> '+JSON.stringify(???, null, 4);+'<br/>';

        if(feature ['ref:h2openmap']!='')
            markerText+='<b>ref h2openmap =</b> '+feature['ref:h2openmap']+'<br/>';

        if(feature ['drinking_water']!='')
            markerText+='<b>drinking water =</b> '+feature['drinking_water']+'<br/>';

        if(feature ['access']!='')
            markerText+='<b>access =</b> '+feature['access']+'<br/>';

        if(feature ['fee']!='')
            markerText+='<b>fee =</b> '+feature['fee']+'<br/>';

        if(feature ['name']!='')
            markerText+='<b>name =</b> '+feature['name']+'<br/>';

        if(feature ['water_well:size']!='')
            markerText+='<b>water well size =</b> '+feature['water_well:size']+'<br/>';

        if(feature ['water_well:top']!='')
            markerText+='<b>water well top =</b> '+feature['water_well:top']+'<br/>';

        if(feature ['pump']!='')
            markerText+='<b>pump =</b> '+feature['pump']+'<br/>';

        if(feature ['pump:manual']!='')
            markerText+='<b>pump manual =</b> '+feature['pump:manual']+'<br/>';

        if(feature ['condition']!='')
            markerText+='<b>condition =</b> '+feature['condition']+'<br/>';

        if(feature ['disused']!='')
            markerText+='<b>disused =</b> '+feature['disused']+'<br/>';

        if(feature ['abandoned']!='')
            markerText+='<b>abandoned =</b> '+feature['abandoned']+'<br/>';

        if(feature ['dry']!='')
            markerText+='<b>dry =</b> '+feature['dry']+'<br/>';

        if(feature ['operator']!='')
            markerText+='<b>operator =</b> '+feature['operator']+'<br/>';

        if(feature ['operator:type']!='')
            markerText+='<b>operator type =</b> '+feature['operator:type']+'<br/>';

        if(feature ['fixme']!='')
            markerText+='<b>fixme:</b> '+feature['fixme']+'<br/>';

        markerText+='</p>';

        if (feature ['description']!='')
        markerText+='<p><b>note = </b>'+feature ['description']+'</p>'; //campo note

        markerText+='<p><a href="#" class="">download PDF</a></p>'; //da fare

        return markerText;
        
}


var map = L.map('map');

var osmTile = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

L.easyButton( '<span class="symbol">&equiv;</span>', function(){
  $('#legend').css('display','block');
}).addTo(map);

var baseMaps= {"OpenStreetMap": osmTile};
var overlayMaps={};

var layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);

$.getJSON('api.php', {'wells': '1'}, function(remoteData){
  var geojson = L.geoJson(remoteData, {
      pointToLayer: function (feature, latlng) {
        var icon = chooseIcon(feature['properties']);
        var marker = L.marker(latlng, {icon: new h2icon( {iconUrl: icon} )} );
        var markerText = buildPopup(feature['properties'], true);
        marker.bindPopup(markerText);
        return marker;
    }
  }).addTo(map);

layerControl.addOverlay(geojson, "h2openmap campaigns");
map.fitBounds(geojson.getBounds(), {'padding': [10,10]});
});

	var layerjson = L.layerJSON({
		url: 'http://overpass-api.de/api/interpreter?data=[out:json];node({lat1},{lon1},{lat2},{lon2})[man_made=water_well];out;',
		propertyItems: 'elements',
		propertyTitle: 'tags.man_made',
		propertyLoc: ['lat','lon'],
		
		buildPopup: function(data, marker) {
           var out = '';
            for (var p in data.tags) {
                out += '<b>'+ p + '=</b>' + data.tags[p] + '<br/>';     
            }
            return ("<b>id=</b> <a target='_blank' href='//www.openstreetmap.org/node/"+data.id+"'>"+data.id+"</a><br/>"
                + out + '<br/>'
                +'<b>Lat=</b>' + data.lat + '<br/>'
                +'<b>Lon=</b>' + data.lon + '<br/>'
                );
            //return (JSON.stringify(data, null, 4));
		},
		buildIcon: function(data, title) {
           var icon = chooseIcon(data.tags);
           return new h2icon( {iconUrl: icon} );
		}
	})
	.addTo(map);
    layerControl.addOverlay(layerjson, "OSM Data");
</script>
</body>
</html>
